# 更新日志 | Changelog

## [v3.0.0] - 2026.01.17 - 使用追踪系统优化与番茄钟功能增强

### 🎯 核心功能更新

#### 使用追踪系统重构
- **专属统计页面**：新增独立的使用统计页面，完整展示使用数据
- **智能按钮设计**：主页显示小巧的使用按钮，点击跳转详细统计
- **趋势图表优化**：自定义SVG图表，支持柱状图和折线图切换
- **视图精简**：移除日视图，专注展示周视图和月视图数据

#### 番茄钟聚焦模式
- **聚焦界面切换**：番茄钟启动时自动切换显示计时信息
- **多位置同步**：主页按钮和折叠条同时显示番茄钟状态
- **状态持久化**：窗口操作不会丢失番茄钟运行状态
- **精准控制**：修复暂停按钮功能，确保开始/暂停正常工作

#### 图表布局优化
- **月视图增强**：动态调整图表宽度，完整显示31天数据
- **响应式设计**：根据数据量智能计算最佳显示尺寸
- **横向滚动**：长数据自动支持水平滚动查看

### 🐛 问题修复

#### 番茄钟功能修复
- **暂停按钮失效**：修复startPomodoro函数逻辑错误
- **状态重置问题**：解决窗口折叠导致番茄钟状态丢失
- **聚焦模式异常**：确保番茄钟状态变化时界面实时更新

#### 用户体验优化
- **双击全屏禁用**：防止误触发全屏模式
- **界面简化**：移除番茄钟组件中的使用时长显示，避免重复

### 🔧 技术改进

#### 状态管理增强
- **localStorage持久化**：番茄钟状态实时保存，防止意外丢失
- **智能恢复机制**：应用重启后自动恢复番茄钟运行状态
- **状态同步优化**：多组件间番茄钟状态完全同步

#### 界面架构优化
- **组件职责分离**：UsageButton专注显示，UsageStats负责详细统计
- **条件渲染优化**：根据番茄钟状态动态切换界面显示
- **代码清理**：移除冗余代码，提升维护性

### 📁 主要文件变更

- `src/pages/UsageStats.tsx` - 新增独立统计页面
- `src/components/UsageButton.tsx` - 新增小巧使用按钮
- `src/components/UsageChart.tsx` - 新增自定义图表组件
- `src/components/UsageTimer.tsx` - 简化为纯番茄钟功能
- `src/store/usageStore.ts` - 增强状态持久化机制
- `src-tauri/tauri.conf.json` - 禁用窗口最大化功能

---

## [2026.01.17] - 悬浮球模式完善与UI优化

### 🎯 核心更新

#### 悬浮球模式重构
- **完全纯净化悬浮球**：移除所有装饰元素，只保留logo图片
- **修复条件渲染逻辑**：`Layout`组件现在正确区分三种模式（`expanded` / `bar` / `floating`）
- **悬浮球独立渲染**：`collapseMode === 'floating'` 时只渲染悬浮球，不显示任何其他UI元素
- **优化交互逻辑**：点击logo直接恢复原窗口，简化用户操作流程

#### 视觉优化
- **logo尺寸统一**：条状模式和展开模式的logo统一调整为 `w-10 h-10`
- **悬浮球尺寸调整**：正常状态从60px调整为55px，吸附状态保持30px
- **完美填充显示**：使用 `flex items-center justify-center` 确保logo居中填满容器
- **移除视觉干扰**：删除紫色边框、hover缩放效果等多余装饰

#### 代码质量提升
- **简化拖拽逻辑**：优化边缘检测和吸附算法，提升性能
- **错误处理增强**：使用 `try-catch-finally` 确保状态一致性
- **防误操作**：添加右键菜单禁用 `onContextMenu={(e) => e.preventDefault()}`
- **注释优化**：简化和规范代码注释，提高可读性

### 🐛 问题修复

#### 悬浮球显示问题
- **修复多余UI元素**：解决悬浮球模式下仍显示折叠按钮等其他控件的问题
- **修复边框干扰**：移除 `ring-2 ring-purple-400` 紫色边框效果
- **修复布局错乱**：通过条件渲染确保只在正确模式下显示对应UI

#### 交互体验优化
- **简化点击逻辑**：区分吸附状态和正常状态的点击行为
- **优化拖拽体验**：改进边缘检测算法，提升拖拽流畅性
- **修复尺寸问题**：确保窗口恢复时尺寸正确

### 🔧 技术改进

#### 日志系统优化
- **减少托盘事件噪音**：只记录实际点击事件，忽略Move等频繁触发的事件
- **简化日志输出**：移除90%以上的重复日志，保留关键调试信息
- **条件日志记录**：根据事件类型智能选择是否输出日志

#### 组件架构优化
- **条件渲染重构**：`Layout`组件使用 `collapseMode` 替代 `isCollapsed` 进行精确判断
- **状态管理优化**：明确区分三种折叠状态的处理逻辑
- **组件解耦**：悬浮球组件完全独立，不依赖其他UI组件

### 📁 文件变更

#### 主要修改文件
- `src/components/FloatingBall.tsx` - 完全重写，实现纯净logo悬浮球
- `src/components/Layout.tsx` - 重构条件渲染逻辑，支持三种模式
- `src-tauri/src/lib.rs` - 优化托盘事件日志输出

#### 核心变更点
```jsx
// 悬浮球模式条件渲染
if (settings.collapseMode === 'floating') {
  return <FloatingBall />; // 只渲染悬浮球
}

// 纯净logo容器
<div className="flex items-center justify-center p-0 m-0">
  <img className="w-full h-full object-cover block p-0 m-0" />
</div>
```

### 🎨 用户体验提升

- **简化操作流程**：悬浮球模式下点击logo即可直接恢复窗口
- **视觉一致性**：logo尺寸在各模式间保持协调统一
- **性能优化**：减少不必要的UI渲染和日志输出
- **交互反馈**：保留必要的拖拽和吸附功能，提升可用性

---

### 📋 开发者注意事项

1. **collapseMode 替代 isCollapsed**：新的条件判断更精确，避免状态混乱
2. **悬浮球独立渲染**：确保floating模式下不会渲染任何其他UI元素  
3. **日志输出控制**：托盘Move事件已静默，只保留关键点击事件日志
4. **组件状态管理**：使用 `try-catch-finally` 确保异步操作的状态一致性

---

*本次更新主要聚焦于悬浮球功能的完善和用户体验的提升，为后续功能开发奠定了良好的基础。*
